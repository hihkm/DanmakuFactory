## DanmukuFactory

DanmakuFactory是一款弹幕文件转换工具，支持特殊弹幕，支持ass，xml，json三种格式互转，~~甚至可以原地tp~~

<img src="images/01.png" alt="pic01" style="zoom: 38%;" />



#### 获取

##### Windows

[DanmakuFactory_1.41_CLI  Beta(蓝奏云)](https://hihkm.lanzous.com/i9pU4dsdl7c)

[DanmakuFactory_1.41_CLI  Beta(GITHUB)](https://github.com/hihkm/DanmakuFactory/releases)

[DanmakuFactory_GUI(~~在做了在做了~~)]()

[1.31  Release](Compiled/release/DanmakuFactory_1.31_release.zip)



##### Linux

需要提前安装git, make, gcc

1. clone仓库到本地(注意当前目录下不要有相同名字的文件夹)

```shell
git clone git@github.com:hihkm/DanmakuFactory.git
```

2. 切换工作目录

```shell
cd DanmakuFactory
```

3. 创建临时文件夹

```shell
mkdir temp
```

4. 编译，可执行文件为DanmakuFactory

```shell
make
```



#### 文件格式支持情况

| 选项      | 操作 | 普通弹幕支持 | 特殊弹幕支持 |
| --------- | ---- | ------------ | ------------ |
| **.ass**  | 读   | 支持         | 支持         |
|           | 写   | 支持         | 支持         |
| **.xml**  | 读   | 支持         | 支持         |
|           | 写   | 支持         | 支持         |
| **.json** | 读   | 支持         | **不支持**   |
|           | 写   | 支持         | **不支持**   |



#### 特性

1.回炉重造，支持读取经过转换后的ass文件，并兼容第三方软件输出的ass文件

2.支持ass以注释的形式保存已经被屏蔽的弹幕，下次重新读取时可重新调整设置

3.支持特殊弹幕！支持特殊弹幕！支持特殊弹幕！
<img src="images/02.png" alt="pic02" style="zoom:38%;" />
*完美支持b站的特殊弹幕，如图为av810872的效果*

4.强大的统计模式
<img src="images/03.png" alt="pic03" style="zoom:38%;" />
*在调试模式中，你可以看到屏幕中各类型弹幕的数量，总共屏蔽掉了的数量，没有被屏蔽的弹幕数量以及总弹幕数量，当然还有一个弹幕分布图*

5.超高的转换效率

*在7300HQ关闭调试模式与弹幕屏蔽的情况下，两个样本文件，3千条弹幕总耗时79ms，109万条弹幕总耗时51064ms。以上时间为老版本，仅作参考*



#### 其他特性

- 支持各类型弹幕互转
- 支持多个弹幕文件合并
- 支持弹幕文字大小、字体、透明度、阴影、描边的调节
- 支持弹幕时间轴整体偏移、屏幕底部防挡留白、支持按屏幕比例调整弹幕密度
- 支持按类型屏蔽、同屏重复弹幕屏蔽
- 支持控制同屏弹幕的密度，也可以直接让弹幕不重叠
- 支持特殊弹幕的转换
- 统计模式，显示统计弹幕数量表格以及弹幕分布直方图
- 纯C代码，完全使用标准库，强大的可移植性



#### 命令行说明

以下展示的是1.40/1.41版本的命令行调用，其余版本请参考打包中的文档

##### 调用方法

```命令行
DanmakuFactory -o [输出文件格式] 输出文件名 -i [输入文件1格式] 输入文件名1 ... [-t 输入文件1的时轴偏移量 ...] [设定名称 设定值] ...
```

##### 解释

1．输入/输出文件格式可选项：**xml, json, ass**

2．当文件后缀明确指出文件格式时，文件格式项可缺省

3．一次性指定的多个输入文件最终合并到一个弹幕池并输出到一个文件，并非批量任务

##### 设定

| 选项                | 解释                                             | 类型（范围）                                                 | 举例                 |
| ------------------- | :----------------------------------------------- | ------------------------------------------------------------ | -------------------- |
| **-x, --resx**      | 指定分辨率宽（像素）                             | 整数(>0)                                                     | -x 1920              |
| **-y, --resy**      | 指定分辨率高（像素）                             | 整数(>0)                                                     | -y 1080              |
| **-s,--scrolltime** | 指定滚动弹幕通过时间（秒）                       | 实数(>0.0)                                                   | -s 12.0              |
| **-f, --fixtime**   | 指定固定弹幕出现时间（秒）                       | 实数(>0.0)                                                   | -f 5.0               |
| **-d, --density**   | 指定弹幕密度（条）                               | 整数(>=-1) **-1**表示不重叠  **0** 表示无限制  **其他**表示限定条数 | -d -1                |
| **-S, --fontsize**  | 指定文字大小                                     | 整数 (>=-0)                                                  | -S 38                |
| **-N, --fontname**  | 指定字体（注意编码问题）                         | 字符串                                                       | -N “Microsoft YaHei” |
| **-O, --opacity**   | 指定不透明度，越小越透明                         | 整数(1-255)                                                  | -O 255               |
| **-L, --outline**   | 指定描边程度                                     | 整数(0-4)  **0** 表示不使用                                  | -L 0                 |
| **-D, --shadow**    | 指定阴影深度                                     | 整数(0-4)  **0** 表示不使用                                  | -D 1                 |
| **--displayarea**   | 指定显示范围，底部留白达到类似“防挡字幕”的效果   | 实数(0.0-1.0) **1.0**表示全屏显示                            | --displayarea  1.0   |
| **--scrollarea**    | 指定滚动弹幕范围，达到按屏幕比例显示弹幕效果     | 实数(0.0-1.0) **1.0**表示全屏显示                            | --scrollarea  0.5    |
| **-b, --blockmode** | 按类型屏蔽，用 ‘-’ 连接各类型，都不屏蔽填null    | 可选值(L2R, R2L, TOP, BOTTOM, SPECIAL, COLOR, REPEAT)        | -b L2R-TOP-BOTTOM    |
| **--statmode**      | 显示弹幕统计，用‘-’连接各类型，都不使用填null    | 可选值(TABLE, HISTOGRAM)                                     | --statmode null      |
| **--saveblocked**   | 指定是否以注释形式保留已屏蔽弹幕，不推荐自行指定 | 可选值(true, false)                                          | --saveblocked true   |

##### *注\*：以上设定仅--blockmode为全部输出文件格式生效，其余仅在ass输出时生效，更详细说明见打包内文档*

##### 其他选项

| 选项             | 解释                                                         |
| ---------------- | ------------------------------------------------------------ |
| **-h, --help**   | **显示帮助文档并退出**                                       |
| **-c, --config** | **在任务之前显示设定信息**                                   |
| **--save**       | **保存当前设定到配置文件，默认显示配置信息 (程序存储目录下的DanmakuFactoryConfig.json)** |



#### 更新日志

##### 1.00
- 原始的一坨可读性爆炸版本

##### 1.10
- 结构调整

##### 1.11
- *跟1.20其实是一个版本，不知怎么的当时就傻掉了╮(╯▽╰)╭
- UI微调
- 逻辑优化

##### 1.30
- 大规模修改UI，改善用户体验（炒鸡麻烦的说）
- 解决编码问题，支持ANSI与UTF-8，解决输入中文字体乱码问题
- 增加批量转换
- 增加命令行调用
- 将配置文件存储为文本形式，并支持对旧二进制配置文件的转换

##### 1.31

- 修复了一些BUG

##### 1.40

- 增加了ass弹幕读入功能，并兼容第三方软件生成的ass弹幕文件

- 增加了xml弹幕写出功能

- 增加了json弹幕读入功能（实验）

- 增加了json弹幕写出功能（实验）

- 增加了写出ass文件时屏蔽弹幕以注释方式保留

- 增加了xml弹幕转义符解析

- 增加了多文件弹幕合并

  

- 修复了特殊弹幕不换行的问题

- 修复了特殊弹幕解析有概率崩溃的问题

- 修复了普通弹幕过长可能导致的崩溃问题

  

- 优化了部分模块，执行效率有所提高

- 改用json文件存储配置信息，便于修改查看

  

- 去除了原本不稳定的编码转换模块（后续可能会使用第三方库）

##### 1.41

- 适配linux
- 修复了部分xml特殊弹幕无法正常解析的问题
- 修复了ass输出后空格失效的问题
- 优化排序，对于原本正序的输入无需重新排序